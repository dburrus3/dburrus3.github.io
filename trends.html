<!DOCTYPE html>
<meta charset="utf-8">

<html>
<head>
    <title>CS416 Narrative Visualization, Summer 2023, dburrus3@illinois.edu</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
</head>

<style>
    h1 { font: 30px Arial Black; color: black; 
        background-color:rgb(245, 245, 245);}
    h2 { font: 24px Arial Black; color: black; }
    body { font: 16px Georgia; color: black; }
    .prevnext { font: 16px Arial Black; cursor: pointer; text-align: center;
        border-radius: 8px; border:2px solid darkgreen; width: 15%; padding: 2px 0px;
        color: darkgreen; background-color:lightgreen;}
    .prevnext:hover { background-color: darkgreen; color: white; }
    .dataSelect { font: 12px Arial Black; cursor: pointer; text-align: center;
        border-radius: 8px; border:1px solid Navy; width: 10%; padding: 2px 0px;
        color: black; background-color:LightSkyBlue;}
    .dataSelect:hover { background-color: MediumBlue; color: white; }
    .gridlines line { stroke: gray; stroke-opacity: 0.6; }
    rect {stroke: white;}
</style>

<body onload="init()">

<h1>Recent Trends</h1>
<h2>Chicagoâ€™s crime rate has improved</h2>
<p>Bar charts on the previous page show reported crimes for the year 2019.</p>
<p>During 2020 and 2021, overall crime rates in Chicago fell an average of <strong>21%</strong>, primarily due to COVID. Crime in 2022 remained <strong>11%</strong> below pre-COVID levels, despite the removal of lockdowns and a general return to normalcy.</p>
<p>However, not all kinds of crime followed the same trend. Click on the <strong>blue buttons</strong> below to see differences in the four major categories of crime, and what is driving recent trends.</p>
</br>
<div id="pageButtons">
    <a href="index.html"><button class="prevnext">< U.S.Cities</button></a>
    <a href="Quiz_8-1-4.html"><button class="prevnext">Locations ></button></a>
</div>
</br>
<div id="chartButtons">
    <a href="trends-2.html"><button class="dataSelect" onClick="choose(2)">Financial</button></a>
    <!-- <button class="dataSelect" onClick="choose(2)">Financial</button> -->
    <button class="dataSelect" onClick="choose(3)">Violent</button>
    <button class="dataSelect" onClick="choose(4)">Property</button>
    <button class="dataSelect" onClick="choose(5)">Statutory</button>
    <button class="dataSelect" onClick="choose(6)">Total</button>
</div>
<div id="chartsdiv"></div>

<script>
// initially display Total Crimes, which is stored in trends[] column 6
var user = 6;

function choose(series){
    // alert("You chose " + series + " - " + desc[series]);
    user = series;
    console.log("Inside choose(): " + user);
    location.reload(true);
    // return user;
} 
console.log("Outside choose(): " + user);
function test(click) {
    const desc = ["Labels", "MonthEnd", "Financial", "Violent", "Property", "Statutory", "Total"]
    alert("You clicked on " + user + " - " + desc[user])
    console.log("Inside test(): " + user)
}

// init function
async function init() {

// load and parse data
const trendsRaw = await d3.csv("https://raw.githubusercontent.com/dburrus3/dburrus3.github.io/main/data/Trends.csv");
var labels = trendsRaw.map(d => d.YearMo);
var months = trendsRaw.map(d => d.MonthEnd).map(dateString => new Date(dateString));
var crimeFina = trendsRaw.map(d => d.Financial).map(Number);
var crimeViol = trendsRaw.map(d => d.Violent).map(Number);
var crimeProp = trendsRaw.map(d => d.Property).map(Number);
var crimeStat = trendsRaw.map(d => d.Statutory).map(Number);
var crimeTotl = trendsRaw.map(d => d.Total).map(Number);
trends = [labels, months, crimeFina, crimeViol, crimeProp, crimeStat, crimeTotl];

// set related variables
var minMonths = new Date(Math.min(...months));
var maxMonths = new Date(Math.max(...months));
var minFina = Math.min(...crimeFina);
var maxFina = Math.max(...crimeFina);
var minViol = Math.min(...crimeViol);
var maxViol = Math.max(...crimeViol);
var minProp = Math.min(...crimeProp);
var maxProp = Math.max(...crimeProp);
var minStat = Math.min(...crimeStat);
var maxStat = Math.max(...crimeStat);
var minTotl = Math.min(...crimeTotl);
var maxTotl = Math.max(...crimeTotl);

var numPts = crimeTotl.length;
var covidStart = labels.indexOf("2020-02");
var covidEnd = labels.indexOf("2021-07");

// ONE WAY TO EXTRACT X AND Y FOR THE LINE CHART ------------------------
//choice = await choose();
//alert("You chose " + choice);
console.log("Where it's needed: " + user)

// select data series to display
xChoose = 1;     // x-axis is always the months, and does not change 
yChoose = user;  // data series 2..6 should come from button click
xValues = trends[0,xChoose];
yValues = trends[0,yChoose];
// axes min and max, changes based on user-selected data series
xMin = Math.min(...xValues);
xMax = Math.max(...xValues);
// add white space at top and bottom, so line does not fill the chart area
yMin = Math.min(...yValues) * 0.50;
yMax = Math.max(...yValues) * 1.10;
// chart title, changes based on user-selected series
seriesName = ["Labels", "MonthEnd", "Financial", "Violent", "Property", "Statutory", "Total"];
// color for line and title, changes based on user-selected series
lineColor = ["Gray", "CadetBlue", "ForestGreen", "FireBrick", "DarkOrange", "HotPink", "DodgerBlue"];

// set chart widths, heights, origin locations, etc.
const screenWd = window.innerWidth;
const screenHt = window.innerHeight; 
var marginWd = Math.round(screenWd * 0.02);
var marginHt = Math.round(screenHt * 0.05);
var marginLabel = Math.round(screenWd * 0.08);
var chartWd = Math.round((screenWd - 3 * marginWd) - marginLabel);
var chartHt = Math.round(screenHt * 0.6) - marginLabel;
var chartOriginX = marginWd + marginLabel;
var chartOriginY = marginHt;

// set scales for the chart
var scaleX = d3.scaleTime()   //  scaleLinear also works
    .domain([xMin, xMax])
    .range([0, chartWd]);

var scaleY = d3.scaleLinear()
    .domain([yMin, yMax])
    .range([chartHt, 0]);

// create SVG container for the line chart
const svg = d3.select("#chartsdiv")
    .append("svg")
    .attr("width", screenWd - 2 * marginWd)
    .attr("height", chartHt + marginHt * marginLabel)
    .attr("id", "charts");

// draw axes for the line chart
var axisX = svg.append("g")
    .attr("transform","translate(" + chartOriginX + "," + (chartOriginY + chartHt) + ")")
    .call(d3.axisBottom(scaleX)
        .tickFormat(d3.timeFormat("%Y-%m"))
        .ticks(numPts))
    .selectAll("text")  
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-70)");

var axisY = svg.append("g")
    .attr("transform","translate(" + chartOriginX + "," + chartOriginY + ")")
    .call(d3.axisLeft(scaleY));
    
// create SVG path based on user-selected data series
var line = function(x, y) {
    return d3.line()
    .x(function(d,i) { return scaleX(x[i]); }) 
    .y(function(d,i) { return scaleY(y[i]); })
    (Array(x.length)); }

// draw path created by line()
var path = svg.append("path")
    .attr("transform","translate(" + chartOriginX + "," + chartOriginY + ")")    
    .attr("d", line(xValues,yValues))
    .attr("stroke", lineColor[yChoose] )
    .attr("stroke-width", 4)
    .attr("fill", "none");

// draw X and Y grid lines to make visual comparison easier
var gridX = svg.append("g")
    .selectAll("line")
    .data(scaleX.ticks())
    .join("line")
    .attr("x1", d => scaleX(d) + chartOriginX)
    .attr("x2", d => scaleX(d) + chartOriginX)
    .attr("y1", chartOriginY)
    .attr("y2", chartOriginY + chartHt)
    // .attr("class", "gridlines")
    .attr("stroke", "gray" )
    .attr("opacity", 0.4);

var gridY = svg.append("g")
    .selectAll("line")
    .data(scaleY.ticks())
    .join("line")
    .attr("x1", chartOriginX)
    .attr("x2", chartOriginX + chartWd)
    .attr("y1", d => scaleY(d) + marginHt)
    .attr("y2", d => scaleY(d) + marginHt)
    // .attr("class", "gridlines")
    .attr("stroke", "gray" )
    .attr("opacity", 0.4);

// display title to indicate which series is being displayed
var chartTitle = svg.append("text")
    .attr("x", chartOriginX + chartWd / 2)
    .attr("y", chartOriginY + marginHt / 1.8)
    .style("text-anchor", "middle")
    .attr("fill", lineColor[yChoose])
    .attr("font-family", "Arial Black")
    .style("font-size", "24px")
    .attr("background-color", "white")
    .text(seriesName[yChoose] + " Crimes Reported by Month");
      
// add annotations to the chart
var annotX1 = chartOriginX + scaleX(xValues[covidStart]);
var annotY1 = chartOriginY + scaleY(yValues[covidStart]);
var annotX2 = chartOriginX + scaleX(xValues[covidEnd]);
var annotY2 = chartOriginY + scaleY(yValues[covidEnd]);

var annotations = [
    {
        note: {
            label: "COVID reaches Chicago",
            lineType: "none",
            orientation: "leftRight", align: "middle",
            wrap: 100, padding: 3      
        },
        // color: "darkred",
        x: annotX1, y: annotY1,
        dx: -30, dy: 60
    }
]
var makeAnnotations = d3.annotation().annotations(annotations)
d3.select("#charts")
    .append("g")
    .call(makeAnnotations)

var annotations = [
{
    note: {
        label: "COVID lockdown ends",
        lineType: "none",
        align: "middle",
        wrap: 100, padding: 3      
    },
    // color: "darkgreen",
    x: annotX2, y: annotY2,
    dx: 10, dy: -50
}
]
var makeAnnotations = d3.annotation().annotations(annotations)
d3.select("#charts")
    .append("g")
    .call(makeAnnotations)

// explanation of crime category
if (yChoose == 2) {
    var annotations = [{
            note: {
                label: "Financial crimes include fraud, forgery, embezzlement, and counterfeiting.",
                lineType: "none", align: "left",
                wrap: 250, padding: 3      
            },
            color: lineColor[yChoose],
            x: chartOriginX + marginWd, 
            y: chartOriginX + chartHt * 0.1,
            dx: 0, dy: 0
        }]
        var makeAnnotations = d3.annotation().annotations(annotations)
        d3.select("#charts").append("g").call(makeAnnotations)
}
if (yChoose == 3) {
    var annotations = [{
            note: {
                label: "Violent crimes include homicide, manslaughter, battery, sexual assault, and robbery.",
                lineType: "none", align: "left",
                wrap: 250, padding: 3      
            },
            color: lineColor[yChoose],
            x: chartOriginX + marginWd, 
            y: chartOriginX + chartHt * 0.5,
            dx: 0, dy: 0
        }]
        var makeAnnotations = d3.annotation().annotations(annotations)
        d3.select("#charts").append("g").call(makeAnnotations)
}
if (yChoose == 4) {
    var annotations = [{
            note: {
                label: "Property crimes include burglary, larceny, vehicle theft, vandalism, and arson.",
                lineType: "none", align: "left",
                wrap: 250, padding: 3      
            },
            color: lineColor[yChoose],
            x: chartOriginX + marginWd, 
            y: chartOriginX + chartHt * 0.6,
            dx: 0, dy: 0
        }]
        var makeAnnotations = d3.annotation().annotations(annotations)
        d3.select("#charts").append("g").call(makeAnnotations)
}
if (yChoose == 5) {
    var annotations = [{
            note: {
                label: "Statutory crimes include disorderly conduct, prostitution, drug abuse, and other illegal behavior.",
                lineType: "none", align: "left",
                wrap: 250, padding: 3      
            },
            color: lineColor[yChoose],
            x: chartOriginX + marginWd, 
            y: chartOriginX + chartHt * 0.5,
            dx: 0, dy: 0
        }]
        var makeAnnotations = d3.annotation().annotations(annotations)
        d3.select("#charts").append("g").call(makeAnnotations)
}

/*

*/

}  // end async function

</script>
</body>
</html>

<!--
    
-->
